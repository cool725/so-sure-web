{% extends 'base_rebrand.html.twig' %}

{# Set vars #}
{% set body_class = 'user-unpaid' %}
{% set show_judo = false %}
{% set show_bacs_setup = false %}
{% set show_bacs_retry = false %}
{% set judo_btn_text = 'Pay by card' %}

{% block title %}
    so-sure
    {% if unpaid_reason == 'unpaid_paid' %}
        - Policy Payment
    {% elseif unpaid_reason == 'unpaid_bacs_mandate_pending' %}
        - Pending Direct Debit Setup
    {% elseif unpaid_reason == 'unpaid_bacs_payment_pending' %}
        - Payment is processing
    {% elseif unpaid_reason == 'unpaid_bacs_mandate_invalid' %}
        - Invalid Direct Debit
    {% elseif unpaid_reason == 'unpaid_bacs_payment_failed' %}
        - Payment failed
    {% elseif unpaid_reason == 'unpaid_bacs_payment_missing' %}
        - Payment missing
    {% elseif unpaid_reason == 'unpaid_judo_card_expired' %}
        - Card Expired
    {% elseif unpaid_reason == 'unpaid_judo_payment_failed' %}
        - Unpaid Policy
    {% elseif unpaid_reason == 'unpaid_judo_payment_missing' %}
        - Unpaid Policy
    {% else %}
        - Unknown payment problem
    {% endif %}
{% endblock %}

{% block cssPage %}
    <link rel="stylesheet" href="{{ asset('css-js/user-unpaid.css') }}">
{% endblock %}

{% block body %}

    <section class="d-flex flex-column justify-content-center align-items-center">
        <div class="container">
            <div class="text-center pt-5 pb-3">
                {% if unpaid_reason == 'unpaid_paid' %}
                    {# ALREADY PAID #}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_phone-smile.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>

                {# DIRECT DEBIT / BACS #}
                {% elseif unpaid_reason == 'unpaid_bacs_mandate_pending' %}
                    {# MANDATE PENDING #}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_phone-smile.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>
                {% elseif unpaid_reason == 'unpaid_bacs_payment_pending' %}
                    {# PAYMENT PENDING #}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_phone-smile.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>
                {% elseif unpaid_reason == 'unpaid_bacs_mandate_invalid' %}
                    {# MANDATE FAILED OR CANCELLED #}
                    {% set show_bacs_setup = true %}
                    {% if not policy.canBacsPaymentBeMadeInTime %}
                        {% set show_judo = true %}
                    {% endif %}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>
                {% elseif unpaid_reason == 'unpaid_bacs_payment_failed' %}
                    {# PAYMENT FAILED #}
                    {% set show_bacs_retry = true %}
                    {% if not policy.canBacsPaymentBeMadeInTime %}
                        {% set show_judo = true %}
                    {% endif %}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>
                {% elseif unpaid_reason == 'unpaid_bacs_payment_missing' %}
                    {# PAYMENT MISSING #}
                    {% set show_bacs_retry = true %}
                    {% if not policy.canBacsPaymentBeMadeInTime %}
                        {% set show_judo = true %}
                    {% endif %}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>

                {# CARD / JUDO PAY #}
                {% elseif unpaid_reason == 'unpaid_judo_card_expired' %}
                    {# CARD EXPIRED #}
                    {% set show_judo = true %}
                    {% if policy.canBacsPaymentBeMadeInTime and bacs_feature %}
                        {% set show_bacs_setup = true %}
                    {% endif %}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    {% if show_bacs_setup %}
                        <h1 class="h2 mb-4">Update your payment details</h1>
                        <p class="lead"><strong>Why not switch to Direct Debit?</strong></p>
                        <img src="{{ cdn_url }}/images/direct-debit-logo.svg" alt="Direct Debit" width="120px" class="mb-4">
                        <p>It helps avoid a lot of the problems with debit / credit card payments…</p>
                        <p>…and only takes seconds to setup!</p>
                    {% else %}
                        <h1 class="h2">Update card details</h1>
                        <p>To avoid your policy being cancelled update your card details now</p>
                    {% endif %}
                {% elseif unpaid_reason == 'unpaid_judo_payment_failed' %}
                    {# PAYMENT FAILED #}
                    {% set show_judo = true %}
                    {% if policy.canBacsPaymentBeMadeInTime and bacs_feature %}
                        {% set show_bacs_setup = true %}
                    {% endif %}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    {% if show_bacs_setup %}
                        <h1 class="h2"></h1>
                        <p class="lead"></p>
                    {% else %}
                        <h1 class="h2"></h1>
                        <p class="lead"></p>
                    {% endif %}
                {% elseif unpaid_reason == 'unpaid_judo_payment_missing' %}
                    {# PAYMENT MISSING #}
                    {% set show_judo = true %}
                    {% if policy.canBacsPaymentBeMadeInTime and bacs_feature %}
                        {% set show_bacs_setup = true %}
                    {% endif %}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    {% if show_bacs_setup %}
                        <h1 class="h2"></h1>
                        <p class="lead"></p>
                    {% else %}
                        <h1 class="h2"></h1>
                        <p class="lead"></p>
                    {% endif %}
                {% else %}
                    {# UNPAID_BACS_UNKNOWN, UNPAID_JUDO_UNKNOWN, UNPAID_UNKNOWN #}
                    <img src="{{ cdn_url }}/images/rebrand/icns/so-sure_icon_broken-phone.png" alt="so-sure" width="180px">

                    <h1 class="h2"></h1>
                    <p class="lead"></p>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="d-flex flex-column justify-content-center align-items-center">
        <div class="container">
            <div class="text-center pb-5">
                {# IF CAN SETUP BACS #}
                {% if show_bacs_setup %}
                    {% set judo_btn_text = 'Rather pay by card?' %}
                    {% if policy.canBacsPaymentBeMadeInTime %}
                        <p>
                            {% if not app.user.hasBacsPaymentMethod %}
                                <a id="setup-bacs-link" href="{{ path('user_payment_details_bacs') }}" class="btn btn-success">Switch to Direct Debit</a>
                            {% else %}
                                <a id="update-bacs-link" href="{{ path('user_payment_details_bacs') }}" class="btn btn-success">Update Direct Debit details</a>
                            {% endif %}
                        </p>

                    {% else %}
                        <p>Sorry, there is not enough time to setup a Direct Debit and take payment before your policy will expire.</p>
                        {% if not show_judo %}
                            <p>Please <a href="mailto:support@wearesosure.com" class="open-intercom">contact us</a>.</p>
                        {% endif %}
                    {% endif %}
                {% endif %}
                {# END - IF CAN SETUP BACS #}
                {# IF CAN RETRY BACS #}
                {% if show_bacs_retry %}
                    {% if policy.canBacsPaymentBeMadeInTime %}
                        {# TODO: Do we need to check mandate status here? #}
                        <p>We need your permission to take &pound;{{ amount|number_format(2, '.', ',') }} from your account ({{ app.user.paymentMethod.bankAccount }}). Once you have given us permission, your payment will be scheduled as soon as possible (within 3 business days).</p>
                        {{ form_start(form, {'attr': {'id': 'reschedule-bacs-form'}})  }}
                            <div class="form-group">
                                {{ form_widget(form.reschedule, {'attr': {'class': 'btn btn-success'}}) }}
                            </div>
                        {{ form_end(form) }}
                    {% else %}
                        <p>Sorry, there is not enough time to retry a Direct Debit payment before your policy will expire.</p>
                        {% if not show_judo %}
                            <p>Please <a href="mailto:support@wearesosure.com" class="open-intercom">contact us</a>.</p>
                        {% endif %}
                    {% endif %}
                {% endif %}
                {# END - IF CAN RETRY BACS #}
                {% if show_judo and webpay_action and webpay_reference and amount > 0 %}
                    <form action="{{ webpay_action }}" method="post" id="webpay-form">
                        <div class="form-group">
                            <input  id="Reference" name="Reference" type="hidden" value="{{ webpay_reference }}">
                            <input type="submit" class="{% if show_bacs_setup %}btn-simple-link{% else %}btn btn-success{% endif %}" value="{{ judo_btn_text }}">
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>
    </section>

    {# Page Modals #}

{% endblock %}

{% block javascriptsPage %}
    <script src="{{ asset('css-js/user-unpaid.js') }}"></script>
{% endblock %}
