{# Intercom #}
<script>
    {% if intercom_enabled is not defined %}
        {% set intercom_enabled = true %}
    {% endif %}
    {% if app is not null and app.session.isStarted %}
        {% set session_referral = app.session.get('referral') %}
        {% set session_scode = app.session.get('scode') %}
        {% set session_quote_url = app.session.get('quote_url') %}
    {% else %}
        {% set session_referral = '' %}
        {% set session_scode = '' %}
        {% set session_quote_url = '' %}
    {% endif %}
    dataLayer = [{
        {% if (app is not defined or app is null) or
            ( (app.user is not defined or app.user is null or not app.user) or
              (app.session.isStarted and is_granted('ROLE_PREVIOUS_ADMIN'))
            )
        %}
            'branch': {
                'banner': true,
                'referral': '{{ session_referral }}',
                'scode': '{{ session_scode }}'
            },
            'user': {
                'id': undefined,
            },
            'intercom': {
                'user_id': null,
                'user_hash': null,
                'email': null,
                'name':  null,
                'created_at': null,
                'quote_url': '{{ session_quote_url }}',
                'enabled': {% if intercom_enabled %}true{% else %}false{% endif %}
            }
        {% else %}
            'branch': {
                'banner': false,
                'referral': '{{ session_referral }}',
                'scode': '{{ session_scode }}'
            },
            'user': {
                'id': '{{ app.user.id }}'
            },
            'intercom': {
                'user_id': '{{ app.user.id }}',
                'user_hash': '{{ intercom(app.user) }}',
                'email': '{{ app.user.email }}',
                'name': '{{ app.user.name }}',
                'created_at': '{{ app.user.created|date('U') }}',
                'quote_url': '{{ session_quote_url }}',
                'enabled': {% if intercom_enabled %}true{% else %}false{% endif %}
            }
        {% endif %}
        {% block gtm_data %}{% endblock %}
    }];
</script>

{% if exclude_remote_scripts is not defined or not exclude_remote_scripts %}

    {# Google Tag Manager #}
    {# NOTE: This code is modifed from the original to pass in environment tags #}
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-KGBBJQ{{ ga_tag_manager_env|raw }}"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl+'{{ ga_tag_manager_env|raw }}';f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KGBBJQ');</script>
    {# End Google Tag Manager #}

{% endif %}
