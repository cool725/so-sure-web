# Learn more about services, parameters and containers at
# http://symfony.com/doc/current/book/service_container.html
parameters:

services:
    _defaults:
        autowire: false      # Automatically injects dependencies in your services.
        autoconfigure: false # Automatically registers your services as commands, event subscribers, etc.
        public: true

    app.user:
        class: AppBundle\Security\FOSUBUserProvider
        arguments: ["@fos_user.user_manager",{facebook: facebookId, starling: starlingId, accountkit: id}]
        calls:
            - [setFacebook, ['@app.facebook']]
            - [setRequestStack, ['@request_stack']]
            - [setEncoderFactory, ["@security.encoder_factory"]]
            - [setAuthService, ["@security.authorization_checker"]]
            - [setDm, ["@doctrine_mongodb.odm.default_document_manager"]]

    app.user.cognitoidentity:
        class: AppBundle\Security\CognitoIdentityUserProvider
        autowire: false
        autoconfigure: false
        arguments:
            - "@fos_user.user_manager"
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@aws.cognito"
            - "%cognito_developer_login%"
            - "%aws_cognito_identitypoolid%"
            - "@logger"
            - "@app.facebook"
            - "%kernel.environment%"

    app.user.cognitoidentity.authenticator:
        class: AppBundle\Security\CognitoIdentityAuthenticator
        arguments:
            - "@security.http_utils"
            - "@logger"

    app.facebook:
        class: AppBundle\Service\FacebookService
        arguments:
            - "@logger"
            - "@router"
            - "%fb_appid%"
            - "%fb_secret%"
            - "%account_kit_secret%"

    app.mailchimp.prelaunch:
        class: AppBundle\Service\MailchimpService
        arguments:
            - "@logger"
            - "%mailchimp_apikey%"
            - "%mailchimp_prelaunch_list%"
            - "%kernel.environment%"

    app.fraud:
        class: AppBundle\Service\FraudService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.judopay:
        class: AppBundle\Service\JudopayService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.policy"
            - "@app.mailer"
            - "%judopay_apitoken%"
            - "%judopay_apisecret%"
            - "%judopay_id%"
            - "%kernel.environment%"
            - "@statsd"
            - "%judopay_webtoken%"
            - "%judopay_websecret%"
            - "@event_dispatcher"
            - "@app.sms"
            - "@app.feature"

    app.payment:
        class: AppBundle\Service\PaymentService
        arguments:
            - "@app.judopay"
            - "@logger"
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@app.sequence"
            - "@app.mailer"
            - "%kernel.environment%"
            - "@app.fraud"
            - "@templating"
            - "@event_dispatcher"

    app.barclays:
        class: AppBundle\Service\BarclaysService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.lloyds:
        class: AppBundle\Service\LloydsService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.user.launch:
        class: AppBundle\Service\LaunchUserService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.mailchimp.prelaunch"
            - "@app.mailer"
            - "@templating"
            - "@app.router"
            - "@app.shortlink"

    app.invitation:
        class: AppBundle\Service\InvitationService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.mailer"
            - "@app.router"
            - "@app.shortlink"
            - "@app.sms"
            - "@app.ratelimit"
            - "@app.push"
            - "%kernel.environment%"
            - "@event_dispatcher"
            - "@app.mixpanel"

    app.scode:
        class: AppBundle\Service\SCodeService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.router"
            - "@app.shortlink"
            - "@app.branch"

    app.bacs:
        class: AppBundle\Service\BacsService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@aws.s3"
            - "%accesspay_s3file_password%"
            - "%kernel.environment%"
            - "@app.mailer"
            - "@snc_redis.default"
            - "@app.payment"
            - "@knp_snappy.pdf"
            - "@templating"

    app.push:
        class: AppBundle\Service\PushService
        arguments:
            - "@logger"
            - "@aws.sns"

    app.claims:
        class: AppBundle\Service\ClaimsService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.mailer"
            - "%kernel.environment%"

    app.shortlink:
        class: AppBundle\Service\ShortLinkService
        arguments:
            - "@logger"
            - "%google_appname%"
            - "%google_apikey%"
            - "@statsd"

    app.intercom:
        class: AppBundle\Service\IntercomService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "%intercom_token%"
            - "@snc_redis.default"
            - "%intercom_secure%"
            - "%intercom_secure_android%"
            - "%intercom_secure_ios%"
            - "@mailer"
            - "@router"

    app.address:
        class: AppBundle\Service\PCAService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "%pca_apikey%"
            - "%kernel.environment%"
            - "@snc_redis.default"

    app.geoip:
        class: AppBundle\Service\MaxMindIpService
        arguments:
            - "@logger"
            - "%geoip_city_db%"
            - "%geoip_country_db%"

    app.cognito.identity:
        class: AppBundle\Service\CognitoIdentityService
        arguments:
            - "@logger"
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@aws.cognito"
            - "%cognito_developer_login%"
            - "%aws_cognito_identitypoolid%"
            - "%kernel.environment%"

    base.imei:
        abstract: true
        class: AppBundle\Service\BaseImeiService
        calls:
            - [setLogger, ['@monolog.logger.receperio']]
            - [setDm, ['@doctrine_mongodb.odm.default_document_manager']]
            - [setMountManager, ['@oneup_flysystem.mount_manager']]
            - [setRedis, ['@snc_redis.default']]

    app.imei:
        parent: base.imei
        autowire: false
        autoconfigure: false
        public: true
        class: AppBundle\Service\ReceperioService
        calls:
            - [setSecretKey, ['%receperio_secretkey%']]
            - [setStoreId, ['%receperio_storeid%']]
            - [setEnvironment, ['%kernel.environment%']]
            - [setRateLimit, ['@app.ratelimit']]
            - [setMailer, ['@app.mailer']]
            - [setStatsd, ['@statsd']]

    app.sanctions:
        class: AppBundle\Service\SanctionsService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.sms:
        class: AppBundle\Service\SmsService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@router"
            - "%plivo_authid%"
            - "%plivo_authtoken%"
            - "%plivo_sendingnumber%"
            - "@templating"
            - "@snc_redis.default"
            - "%kernel.environment%"

    app.branch:
        class: AppBundle\Service\BranchService
        arguments:
            - "@logger"
            - "@app.router"
            - "@snc_redis.default"
            - "%kernel.environment%"
            - "%branch_key%"
            - "%branch_secret%"
            - "%branch_domain%"
            - "%google_app_download%"
            - "%apple_app_download%"

    app.request:
        class: AppBundle\Service\RequestService
        arguments:
            - "@request_stack"
            - "@logger"
            - "@security.token_storage"
            - "%sosure_employee_cookie_value%"
            - "%kernel.environment%"

    app.twig.branch:
        class: AppBundle\Service\BranchTwigExtension
        arguments:
            - "@app.branch"
            - "@logger"
            - "@app.request"
        public: true
        tags:
            - { name: twig.extension }

    app.twig.accountkit:
        class: AppBundle\Service\AccountkitTwigExtension
        arguments:
            - "@hwi_oauth.resource_owner.accountkit"
            - "@logger"
        public: true
        tags:
            - { name: twig.extension }

    app.twig.s3:
        class: AppBundle\Service\S3TwigExtension
        arguments:
            - "@aws.s3"
        public: false
        tags:
            - { name: twig.extension }

    app.twig.intercom:
        class: AppBundle\Service\IntercomTwigExtension
        arguments:
            - "@app.intercom"
            - "@logger"
        public: false
        tags:
            - { name: twig.extension }

    app.twig.misc:
        class: AppBundle\Service\MiscTwigExtension
        arguments:
            - "@request_stack"
            - "@logger"
        public: false
        tags:
            - { name: twig.extension }

    app.twig.request:
        class: AppBundle\Service\RequestTwigExtension
        arguments:
            - "@app.request"
            - "@logger"
        public: false
        tags:
            - { name: twig.extension }

    app.excel:
        class: AppBundle\Service\ExcelService
        arguments:
            - "@logger"

    app.salva:
        class: AppBundle\Service\SalvaExportService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "%salva_url%"
            - "%salva_username%"
            - "%salva_password%"
            - "%kernel.root_dir%"
            - "@snc_redis.default"
            - "@aws.s3"
            - "%kernel.environment%"
            - "@app.feature"
        tags:
            - { name: monolog.logger, channel: salva }

    base.s3email:
        abstract: true
        class: AppBundle\Service\S3EmailService
        calls:
            - [setLogger, ['@monolog.logger.receperio']]
            - [setDm, ['@doctrine_mongodb.odm.default_document_manager']]
            - [setExcel, ['@app.excel']]
            - [setS3, ['@aws.s3']]
            - [setEnvironment, ['%kernel.environment%']]

    app.davies:
        parent: base.s3email
        autowire: false
        autoconfigure: false
        public: true
        class: AppBundle\Service\DaviesService
        calls:
            - [setClaims, ['@app.claims']]
            - [setMailer, ['@app.mailer']]
            - [setBucket, ['ops.so-sure.com']]
            - [setPath, ['claims-report']]
            - [setValidator, ['@validator']]
            - [setFeature, ['@app.feature']]
        tags:
            - { name: monolog.logger, channel: davies }

    app.brightstar:
        parent: base.s3email
        autowire: false
        autoconfigure: false
        public: true
        class: AppBundle\Service\BrightstarService
        calls:
            - [setBucket, ['ops.so-sure.com']]
            - [setPath, ['brightstar-report']]
            - [setMailer, ['@app.mailer']]
        tags:
            - { name: monolog.logger, channel: davies }

    app.jwt:
        class: AppBundle\Service\JWTService
        arguments:
            - "@logger"
            - "%api_secret%"

    app.sequence:
        class: AppBundle\Service\SequenceService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.policy:
        class: AppBundle\Service\PolicyService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.sequence"
            - "@app.mailer"
            - "@swiftmailer.transport.real"
            - "@templating"
            - "@app.router"
            - "%kernel.environment%"
            - "@knp_snappy.pdf"
            - "@event_dispatcher"
            - "@aws.s3"
            - "@app.shortlink"
            - "@statsd"
            - "@snc_redis.default"
            - "@app.branch"
            - "@app.address"
            - "@app.imei"
            - "@app.ratelimit"
            - "@app.intercom"
            - "@app.sms"
            - "@app.scode"
            - "@app.sixpack"

    app.quote:
        class: AppBundle\Service\QuoteService
        arguments:
            - "@app.mailer"
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@snc_redis.default"

    app.invoice:
        class: AppBundle\Service\InvoiceService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.sequence"
            - "@app.mailer"
            - "@swiftmailer.transport.real"
            - "@templating"
            - "%kernel.environment%"
            - "@knp_snappy.pdf"
            - "@aws.s3"

    app.mailer:
        class: AppBundle\Service\MailerService
        arguments:
            - "@mailer"
            - "@swiftmailer.transport.real"
            - "@templating"
            - "@app.router"
            - "%default_sender_address%"
            - "%default_sender_name%"

    app.router:
        class: AppBundle\Service\RouterService
        arguments:
            - "@router"
            - "%web_base_url%"

    app.ratelimit:
        class: AppBundle\Service\RateLimitService
        arguments:
            - "@snc_redis.default"
            - "@logger"
            - "%kernel.environment%"

    statsd_client:
        class: Domnikl\Statsd\Connection\UdpSocket
        arguments:
            - "localhost"
            - "8125"

    statsd:
        class: Domnikl\Statsd\Client
        arguments:
            - "@statsd_client"
            - "sosure"

    app.stats:
        class: AppBundle\Service\StatsService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@snc_redis.default"
            - "@logger"

    app.phone:
        class: AppBundle\Service\PhoneService
        arguments:
            - "@logger"

    app.logger.rollbar:
        class: AppBundle\Classes\Rollbar
        arguments:
            - access_token: '%rollbar_access_token%'

    app.logger.rollbar-security:
        class: AppBundle\Classes\Rollbar
        arguments:
            - access_token: '%rollbar_access_token%'

    app.logger.lineformatter:
        class: Monolog\Formatter\LineFormatter
        calls:
            - [includeStacktraces]

    aws.credentials:
        class: Aws\Credentials\Credentials
        arguments:
            - "%aws_key%"
            - "%aws_secret%"

    aws.cognito:
        class: Aws\CognitoIdentity\CognitoIdentityClient
        arguments:
            -
                version: "latest"
                region: "eu-west-1"
                credentials: "@aws.credentials"

    aws.sns:
        class: Aws\Sns\SnsClient
        arguments:
            -
                version: "latest"
                region: "eu-west-1"
                credentials: "@aws.credentials"

    aws.s3:
        class: Aws\S3\S3Client
        arguments:
            -
                version: "latest"
                region: "eu-west-1"
                credentials: "@aws.credentials"

    api.router:
        class: AppBundle\Service\ApiRouterService
        arguments:
            - "@router"
            - 8080
            - 80
            - 443

    app.monitor:
        class: AppBundle\Service\MonitorService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@snc_redis.default"
            - "@app.intercom"
            - "@app.mixpanel"
            - "@app.judopay"

    app.annie:
        class: AppBundle\Service\AppAnnieService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "%appannie_apikey%"
            - "@app.stats"

    app.reporting:
        class: AppBundle\Service\ReportingService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "%report_excluded_policy_ids%"
            - "%kernel.environment%"
            - "@snc_redis.default"

    app.mixpanel:
        class: AppBundle\Service\MixpanelService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@snc_redis.default"
            - "@mixpanel"
            - "@app.request"
            - "%mixpanel_apisecret%"
            - "@app.stats"
            - "@census.search"

    app.sixpack:
        class: AppBundle\Service\SixpackService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "%sixpack_url%"
            - "@app.request"
            - "@app.mixpanel"

    app.feature:
        class: AppBundle\Service\FeatureService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.twig.feature:
        class: AppBundle\Service\FeatureTwigExtension
        arguments:
            - "@app.feature"
        public: false
        tags:
            - { name: twig.extension }

    mixpanel:
        class:   Mixpanel
        factory: ['Mixpanel', getInstance]
        arguments: ['%mixpanel_apitoken%']

    app.voter.user:
        class: AppBundle\Security\UserVoter
        tags:
            - { name: security.voter }

    app.voter.policy:
        class: AppBundle\Security\PolicyVoter
        tags:
            - { name: security.voter }

    app.voter.invitation:
        class: AppBundle\Security\InvitationVoter
        tags:
            - { name: security.voter }

    app.voter.multiPay:
        class: AppBundle\Security\MultiPayVoter
        tags:
            - { name: security.voter }

    doctrine.listener.invitation:
        class:   AppBundle\Listener\DoctrineInvitationListener
        arguments:
            - "@event_dispatcher"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: postPersist }
            -  { name: doctrine_mongodb.odm.event_listener, event: postUpdate  }

    doctrine.listener.lead:
        class:   AppBundle\Listener\DoctrineLeadListener
        arguments:
            - "@event_dispatcher"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: postPersist }
            -  { name: doctrine_mongodb.odm.event_listener, event: postUpdate  }

    doctrine.listener.user:
        class:   AppBundle\Listener\DoctrineUserListener
        arguments:
            - "@event_dispatcher"
            - "@logger"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: postPersist }
            -  { name: doctrine_mongodb.odm.event_listener, event: preUpdate  }
            -  { name: doctrine_mongodb.odm.event_listener, event: postUpdate  }
            -  { name: doctrine_mongodb.odm.event_listener, event: preRemove  }

    doctrine.listener.company:
        class:   AppBundle\Listener\DoctrineCompanyListener
        arguments:
            - "@event_dispatcher"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: postPersist }

    doctrine.listener.claim:
        class:   AppBundle\Listener\DoctrineClaimListener
        arguments:
            - "@event_dispatcher"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: postPersist }
            -  { name: doctrine_mongodb.odm.event_listener, event: preUpdate  }

    doctrine.listener.connection:
        class:   AppBundle\Listener\DoctrineConnectionListener
        arguments:
            - "@event_dispatcher"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: preUpdate  }

    doctrine.listener.salva:
        class:   AppBundle\Listener\DoctrineSalvaListener
        arguments:
            - "@event_dispatcher"
            - "%kernel.environment%"
            - "@logger"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: preUpdate  }

    doctrine.listener.policy:
        class:   AppBundle\Listener\DoctrinePolicyListener
        arguments:
            - "@event_dispatcher"
            - "%kernel.environment%"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: preUpdate  }
            -  { name: doctrine_mongodb.odm.event_listener, event: preRemove  }

    doctrine.listener.validation:
        class:   AppBundle\Listener\DoctrineValidationListener
        arguments:
            - "@event_dispatcher"
        tags:
            -  { name: doctrine_mongodb.odm.event_listener, event: prePersist }
            -  { name: doctrine_mongodb.odm.event_listener, event: preUpdate  }

    app.listener.validation:
        class:   AppBundle\Listener\ValidationListener
        arguments:
            - "@validator"
            - "@logger"
        tags:
            -  { name: kernel.event_listener, event: event.validate, method: onValidateEvent }

    app.listener.policy:
        class:   AppBundle\Listener\PolicyListener
        arguments:
            - "@app.policy"
            - "@logger"
        tags:
            -  { name: kernel.event_listener, event: event.connection.reduced, method: onConnectionReducedEvent }

    app.listener.user:
        class:   AppBundle\Listener\UserListener
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.mailer"
            - "@snc_redis.default"
            - "@app.user"
        tags:
            -  { name: kernel.event_listener, event: event.user.created, method: onUserCreatedEvent }
            -  { name: kernel.event_listener, event: event.user.updated, method: onUserUpdatedEvent }
            -  { name: kernel.event_listener, event: event.user.email.changed, method: onUserEmailChangedEvent }
            -  { name: kernel.event_listener, event: event.user.password.changed, method: onUserPasswordChangedEvent }

    app.listener.bacs:
        class:   AppBundle\Listener\BacsListener
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@app.validator.bankaccountname"
            - "@app.bacs"
        tags:
            -  { name: kernel.event_listener, event: event.user.name.updated, method: onUserNameChangedEvent }
            -  { name: kernel.event_listener, event: event.bacs.updated, method: onBankAccountChangedEvent }
            -  { name: kernel.event_listener, event: event.policy.bacs-created, method: onPolicyBacsCreated }
            -  { name: kernel.event_listener, event: event.policy.updated-premium, method: onPolicyUpdatedPremium }
            -  { name: kernel.event_listener, event: event.policy.updated-billing, method: onPolicyUpdatedBilling }

    app.listener.debtCollection:
        class:   AppBundle\Listener\DebtCollectionListener
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
        tags:
            -  { name: kernel.event_listener, event: event.payment.success, method: onPaymentSuccessEvent }

    app.listener.intercom:
        class:   AppBundle\Listener\IntercomListener
        arguments:
            - "@app.intercom"
        tags:
            -  { name: kernel.event_listener, event: event.lead.updated, method: onLeadUpdatedEvent }
            -  { name: kernel.event_listener, event: event.user.created, method: onUserCreatedEvent }
            -  { name: kernel.event_listener, event: event.user.updated, method: onUserUpdatedEvent }
            -  { name: kernel.event_listener, event: event.policy.created, method: onPolicyCreatedEvent }
            -  { name: kernel.event_listener, event: event.policy.pot, method: onPolicyPotEvent }
            -  { name: kernel.event_listener, event: event.policy.cancelled, method: onPolicyCancelledEvent }
            -  { name: kernel.event_listener, event: event.policy.pending-renewal, method: onPolicyPendingRenewedEvent }
            -  { name: kernel.event_listener, event: event.policy.renewed, method: onPolicyRenewedEvent }
            -  { name: kernel.event_listener, event: event.policy.start, method: onPolicyStartEvent }
            -  { name: kernel.event_listener, event: event.policy.unpaid, method: onPolicyUnpaidEvent }
            -  { name: kernel.event_listener, event: event.policy.reactivated, method: onPolicyReactivatedEvent }
            -  { name: kernel.event_listener, event: event.invitation.accepted, method: onInvitationAcceptedEvent }
            -  { name: kernel.event_listener, event: event.connection.connected, method: onConnectionConnectedEvent }
            -  { name: kernel.event_listener, event: event.payment.success, method: onPaymentSuccessEvent }
            -  { name: kernel.event_listener, event: event.payment.failed, method: onPaymentFailedEvent }
            -  { name: kernel.event_listener, event: event.payment.first-problem, method: onPaymentFirstProblemEvent }
            -  { name: kernel.event_listener, event: event.user.payment.failed, method: onUserPaymentFailedEvent }
            -  { name: kernel.event_listener, event: event.claim.created, method: onClaimCreatedEvent }
            -  { name: kernel.event_listener, event: event.claim.approved, method: onClaimApprovedEvent }
            -  { name: kernel.event_listener, event: event.claim.settled, method: onClaimSettledEvent }

    app.listener.sanctions:
        class:   AppBundle\Listener\SanctionsListener
        arguments:
            - "@app.sanctions"
            - "@snc_redis.default"
        tags:
            -  { name: kernel.event_listener, event: event.user.created, method: onUserCreatedEvent }
            -  { name: kernel.event_listener, event: event.company.created, method: onCompanyCreatedEvent }

    app.listener.mixpanel:
        class:   AppBundle\Listener\MixpanelListener
        arguments:
            - "@app.mixpanel"
        tags:
            -  { name: kernel.event_listener, event: event.payment.success, method: onPaymentSuccessEvent }
            -  { name: kernel.event_listener, event: event.policy.created, method: onPolicyCreatedEvent }
            -  { name: kernel.event_listener, event: event.policy.cancelled, method: onPolicyCancelledEvent }
            -  { name: kernel.event_listener, event: event.policy.renewed, method: onPolicyRenewedEvent }
            -  { name: kernel.event_listener, event: event.policy.cashback, method: onPolicyCashbackEvent }
            -  { name: kernel.event_listener, event: event.policy.declined-renewal, method: onPolicyDeclineRenewedEvent }

    app.listener.sixpack:
        class:   AppBundle\Listener\SixpackListener
        arguments:
            - "@app.sixpack"
        tags:
            -  { name: kernel.event_listener, event: event.policy.created, method: onPolicyCreatedEvent }

    app.listener.push:
        class:   AppBundle\Listener\PushListener
        arguments:
            - "@app.push"
        tags:
            -  { name: kernel.event_listener, event: event.policy.pending-renewal, method: onPolicyPendingRenewalEvent }

    app.listener.salva:
        class:   AppBundle\Listener\SalvaListener
        arguments:
            - "@app.salva"
        tags:
            -  { name: kernel.event_listener, event: event.policy.created, method: onPolicyCreatedEvent }
            -  { name: kernel.event_listener, event: event.policy.salva_increment, method: onPolicySalvaIncrementEvent }
            -  { name: kernel.event_listener, event: event.policy.cancelled, method: onPolicyCancelledEvent }

    app.listener.refund:
        class:   AppBundle\Listener\RefundListener
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@app.judopay"
            - "@logger"
            - "%kernel.environment%"
        tags:
            -  { name: kernel.event_listener, event: event.policy.cancelled, method: onPolicyCancelledEvent }
            -  { name: kernel.event_listener, event: event.policy.created, method: refundFreeMonthPromo }

    app.listener.response:
        class:   AppBundle\Listener\KernelListener
        arguments:
            - "@security.token_storage"
            - "@security.authorization_checker"
            - "%sosure_employee_cookie_value%"
            - "@logger"
            - "%kernel.environment%"
            - "%sosure_employee_cookie_domain%"
        tags:
            -  { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }
            -  { name: kernel.event_listener, event: kernel.response, method: onKernelResponse }

    app.listener.security:
        class:   AppBundle\Listener\SecurityListener
        arguments:
            - "@logger"
            - "@request_stack"
            - "@event_dispatcher"
            - "@app.mixpanel"
            - "@snc_redis.default"
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@app.mailer"
        tags:
            -  { name: kernel.event_listener, event: security.interactive_login, method: onSecurityInteractiveLogin }
            -  { name: kernel.event_listener, event: security.interactive_login.actual, method: onActualSecurityInteractiveLogin }
            -  { name: kernel.event_listener, event: security.authentication.failure, method: onAuthenticationFailure }

    app.listener.mailer:
        class:  AppBundle\Listener\MailerListener
        # for now, comment out to avoid circular ref - add back once swift log emailer not in use
        arguments:
            - "@logger"
            - "%kernel.root_dir%/../app/spool/requeue"
        tags:
          - { name: monolog.logger, channel: mailer }
          - { name: "swiftmailer.default.plugin" }

    app.form.type.registration:
        class: AppBundle\Form\Type\RegistrationFormType
        arguments: ["@request_stack", "%kernel.environment%"]
        tags:
            - { name: form.type, alias: app_user_registration }

    app.form.type.usersearch:
        class: AppBundle\Form\Type\UserSearchType
        arguments: ["@request_stack", "%kernel.environment%"]
        tags:
            - { name: form.type }

    app.form.type.picsuresearch:
        class: AppBundle\Form\Type\PicSureSearchType
        arguments: ["@request_stack"]
        tags:
            - { name: form.type }

    app.form.type.chargebacks:
        class: AppBundle\Form\Type\ChargebacksType
        arguments: ["@request_stack", "%kernel.environment%"]
        tags:
            - { name: form.type }

    app.form.type.policysearch:
        class: AppBundle\Form\Type\PolicySearchType
        arguments: ["@request_stack", "%kernel.environment%"]
        tags:
            - { name: form.type }

    app.form.type.claimsearch:
        class: AppBundle\Form\Type\ClaimSearchType
        arguments: ["@request_stack"]
        tags:
            - { name: form.type }

    app.form.type.cashbacksearch:
        class: AppBundle\Form\Type\CashbackSearchType
        arguments: ["@request_stack", "%kernel.environment%"]
        tags:
            - { name: form.type }

    app.form.type.phonemake:
        class: AppBundle\Form\Type\PhoneMakeType
        arguments: ["@doctrine_mongodb.odm.default_document_manager", "%form_required%", "@app.request"]
        tags:
            - { name: form.type }

    app.form.type.bacsuploadfile:
        class: AppBundle\Form\Type\BacsUploadFileType
        tags:
            - { name: form.type }

    app.form.type.mandates:
        class: AppBundle\Form\Type\BacsMandatesType
        arguments: ["@doctrine_mongodb.odm.default_document_manager"]
        tags:
            - { name: form.type }

    app.form.type.claimfnol:
        class: AppBundle\Form\Type\ClaimFnolType
        arguments: ["%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.phonesearch:
        class: AppBundle\Form\Type\PhoneSearchType
        arguments: ["@request_stack"]
        tags:
            - { name: form.type }

    app.form.type.renew:
        class: AppBundle\Form\Type\RenewType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.renewcashback:
        class: AppBundle\Form\Type\RenewCashbackType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.bacs:
        class: AppBundle\Form\Type\BacsType
        arguments: ["@app.address", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.bacsconfirm:
        class: AppBundle\Form\Type\BacsConfirmType
        arguments: ["@app.address", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.cashback:
        class: AppBundle\Form\Type\CashbackType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.purchasesteppersonal:
        class: AppBundle\Form\Type\PurchaseStepPersonalType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.purchasesteppersonaladdress:
        class: AppBundle\Form\Type\PurchaseStepPersonalAddressType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.purchasesteppersonaladdressdropdown:
        class: AppBundle\Form\Type\PurchaseStepPersonalAddressDropdownType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.purchasestepaddress:
        class: AppBundle\Form\Type\PurchaseStepAddressType
        arguments: ["%form_required%"]
        tags:
            - { name: form.type }

    app.form.type.purchasestepphone:
        class: AppBundle\Form\Type\PurchaseStepPhoneType
        arguments: ["@request_stack", "%form_required%", "@app.imei", "@logger"]
        tags:
            - { name: form.type }

    app.form.type.claim:
        class: AppBundle\Form\Type\ClaimType
        arguments: ["@app.imei"]
        tags:
            - { name: form.type }

    app.form.type.claimcrimeref:
        class: AppBundle\Form\Type\ClaimCrimeRefType
        arguments: ["@app.imei"]
        tags:
            - { name: form.type }

    app.form.type.claimscheck:
        class: AppBundle\Form\Type\ClaimsCheckType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    app.validator.age:
        class: AppBundle\Validator\Constraints\AgeValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.renewalconnectionsamount:
        class: AppBundle\Validator\Constraints\RenewalConnectionsAmount
        tags:
            - { name: validator.constraint_validator }

    app.validator.alphanumeric:
        class: AppBundle\Validator\Constraints\AlphanumericValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.alphanumericspacedot:
        class: AppBundle\Validator\Constraints\AlphanumericSpaceDotValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.token:
        class: AppBundle\Validator\Constraints\TokenValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.mobile:
        class: AppBundle\Validator\Constraints\MobileValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.imei:
        class: AppBundle\Validator\Constraints\ImeiValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.serialnumber:
        class: AppBundle\Validator\Constraints\SerialNumberValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.postcode:
        class: AppBundle\Validator\Constraints\PostcodeValidator
        arguments: ["@app.address"]
        tags:
            - { name: validator.constraint_validator }

    app.validator.sortcode:
        class: AppBundle\Validator\Constraints\SortCodeValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.bankaccountnumber:
        class: AppBundle\Validator\Constraints\BankAccountNumberValidator
        tags:
            - { name: validator.constraint_validator }

    app.validator.bankaccountname:
        class: AppBundle\Validator\Constraints\BankAccountNameValidator
        arguments:
            - "@app.request"
            - "@logger"
        tags:
            - { name: validator.constraint_validator }

    rollbar.voter.notfound:
        class: AppBundle\Security\NotFoundHttpExceptionVoter
        tags:
            - { name: staffim_rollbar.report_voter }

    rollbar.voter.untrustedhost:
        class: AppBundle\Security\UntrustedHostUnexpectedValueExceptionVoter
        tags:
            - { name: staffim_rollbar.report_voter }

    rollbar.voter.runtime:
        class: AppBundle\Security\RuntimeExceptionVoter
        tags:
            - { name: staffim_rollbar.report_voter }

    rollbar.voter.accessdenied:
        class: AppBundle\Security\AccessDeniedHttpExceptionVoter
        arguments:
            - "@request_stack"
            - ["%sosure_rwe_ip%", "%sosure_patrick_ip%"]
        tags:
            - { name: staffim_rollbar.report_voter }

    sitemap.phone:
        class: AppBundle\Service\PhoneSitemapGenerator
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"
            - "@router"
        tags:
            - { name: dpn_xml_sitemap.generator }

    two_factor.persister:
        class: AppBundle\Service\DoctrinePersister
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"

    twig.extension.intl:
        class: Twig_Extensions_Extension_Intl
        tags:
            - { name: twig.extension }

    census.search:
        class: CensusBundle\Service\SearchService
        arguments:
            - "@doctrine_mongodb.odm.census_document_manager"

    app.gender:
        class: AppBundle\Service\GenderizeService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@logger"

    app.ops.datacollector:
        class: AppBundle\Service\OpsDataCollector
        tags:
            -
                name:     data_collector
                template: 'opsDataCollector'
                id: "app.ops_collector"
        public: false

    picsureml.picsureml:
        class: PicsureMLBundle\Service\PicsureMLService
        arguments:
            - "@doctrine_mongodb.odm.default_document_manager"
            - "@doctrine_mongodb.odm.picsureml_document_manager"
            - "@oneup_flysystem.mount_manager"
            - "@aws.s3"

    picsureml.listener.picsureml:
        class:   PicsureMLBundle\Listener\PicsureMLListener
        arguments:
            - "@picsureml.picsureml"
            - "@logger"
        tags:
            -  { name: kernel.event_listener, event: event.picsure.received, method: onReceivedEvent }
            -  { name: kernel.event_listener, event: event.picsure.approved, method: onUndamagedEvent }
            -  { name: kernel.event_listener, event: event.picsure.invalid, method: onInvalidEvent }
            -  { name: kernel.event_listener, event: event.picsure.rejected, method: onDamagedEvent }

    picsureml.form.type.search:
        class: PicsureMLBundle\Form\Type\SearchType
        arguments: ["@request_stack", "@picsureml.picsureml", "%form_required%"]
        tags:
            - { name: form.type }

    picsureml.form.type.newversion:
        class: PicsureMLBundle\Form\Type\NewVersionType
        arguments: ["@picsureml.picsureml", "%form_required%"]
        tags:
            - { name: form.type }

    picsureml.form.type.annotate:
        class: PicsureMLBundle\Form\Type\AnnotateType
        arguments: ["@request_stack", "%form_required%"]
        tags:
            - { name: form.type }

    picsureml.form.type.label:
        class: PicsureMLBundle\Form\Type\LabelType
        arguments: ["@picsureml.picsureml", "%form_required%"]
        tags:
            - { name: form.type }
