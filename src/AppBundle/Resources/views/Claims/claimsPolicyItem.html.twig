<div id="claimPolicyItem">
    <div class="text-center" style="background-color: {{ policy.riskColour }}; color: white; font-weight: bold; border-radius: 4px; margin-bottom: 20px; padding: 10px;">
      Risk: {{ policy.riskReason }} ({{ policy.risk }})
    </div>
    {% if policy.pendingCancellation %}
    <div class="text-center" style="background-color: red; color: white; font-weight: bold; border-radius: 4px; margin-bottom: 20px; padding: 10px;">
      Policy is pending cancellation. {{ policy.pendingCancellation | date }}
    </div>
    {% endif %}
    <ul class="nav nav-tabs nav-justified">
      <li role="presentation" class="active"><a href="#user">User</a></li>
      <li role="presentation"><a href="#policy">Policy</a></li>
      <li role="presentation"><a href="#claims">Claims <span class="badge" title="Number of claims">{{ policy.claims|length }}</span></a></li>
      <li role="presentation"><a href="#network">Network Claims <span class="badge" title="Number of network claims">{{ policy.networkClaims|length }}</span></a></li>
      <li role="presentation"><a href="#history">History</a></li>
      {% if is_granted('ROLE_ADMIN') %}
        <li role="presentation"><a href="#admin">Admin</a></li>
      {% endif %}
    </ul>
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane" id="policy">
            <div class="row">
                <div class="col-md-7">
                    <h2>Policy</h2>
                    <table class="table table-striped">
                        <tr>
                            <td>Policy Number</td>
                            <td>
                                {% if policy.policyNumber|length %}
                                    {{ policy.policyNumber }}
                                {% else %}
                                    N/A 
                                {% endif %}
                            </td>
                        </tr>
                        {% if policy.phone %}
                        <tr>
                            <td>Phone</td>
                            <td>{{ policy.phone }}&nbsp;
                                    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#alternativeModal"
                                        data-query="{{ path('claims_phone_alternatives', {'id': policy.phone.id}) }}"
                                        data-phone="{{ policy.phone.toAlternativeArray()|json_encode }}"
                                        >Show Alternatives</button>
    
                            </td>
                        </tr>
                        <tr>
                            <td>IMEI</td>
                            <td>{{ policy.imei }}
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td>Policy Status</td>
                            <td>
                              {{ policy.status }} {% if not policy.isPolicy %}Pre-pending{% endif %}
                              {% if policy.cancelledReason %}
                                / {{ policy.cancelledReason }}
                              {% endif %}
                            </td>
                        </tr>
                        {% if policy.isPolicy %}
                        <tr>
                            <td>Policy Dates</td>
                            <td>{{ policy.start | date('d M Y H:i', 'Europe/London') }} - {{ policy.end | date('d M Y H:i', 'Europe/London') }}</td>
                        </tr>
                        {% endif %}
                        {% if policy.isPolicy %}
                        <tr>
                            <td>Policy Payments</td>
                            <td>
                                Paid £{{ policy.premiumPaid | number_format(2, '.', ',') }} of £{{ policy.premium.yearlyPremiumPrice| number_format(2, '.', ',') }}&nbsp;
                            ({{ policy.successfulPaymentCredits|length }} / {{ policy.payments|length }} <span title="Successful / Total">payments</span>)
                            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#paymentsModal"
                                            >Payments</button>
                            
                            </td>
                        </tr>
                        {% endif %}
                        {% if policy.isPolicy %}
                        <tr>
                            <td>Policy Payment Status</td>
                            <td>
                                {% if policy.isPolicyPaidToDate %}
                                    <i class="fa fa-check text-success" title="Policy is paid to date"></i> Policy is paid to date
                                {% else %}
                                    <i class="fa fa-warning text-danger" title="Policy is NOT paid to date"></i>
                                    Policy will be cancelled on {{ policy.policyExpirationDate | date('d M Y H:i', 'Europe/London')}}
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% if policy.isPolicy %}
                        <tr>
                            <td>Policy Installments</td>
                            <td>{{ policy.premiumInstallmentCount }} installment(s) of £{{ policy.premiumInstallmentPrice| number_format(2, '.', ',') }}</td>
                        </tr>
                        {% endif %}
                        {% if policy.isPolicy %}
                        <tr>
                            <td>Card</td>
                            {% if policy.user.paymentMethod %}
                            <td class="{% if policy.user.paymentMethod.isCardExpired %}danger{% endif %}">{{ policy.user.paymentMethod }}</td>
                            {% else %}
                            <td class="danger">Missing payment card</td>
                            {% endif %}
                        </tr>
                        {% endif %}
                        <tr>
                          <td>ClaimsCheck Cert Id</td>
                          <td>
                            {% for key, data in policy.checkmendCertsAsArray if data['certId'] is defined %}
                                {% if data['certId'] == 'serial' %}
                                    <span title="{{ data['response']|json_encode }}" style="cursor: pointer;">{{ data['certId'] }}</span>
                                {% else %}
                                  <a href="https://www.checkmend.com/uk/verify/{{ data['certId'] }}" target="_blank" title="{{ data['response']|json_encode }}">{{ data['certId'] }}</a>
                                {% endif %}
                                ({{ key|date("F j, Y H:i", "Europe/London") }})<br />
                            {% endfor %}
                            {% if policy.checkmendCerts|length == 0 %}
                              Certs not present
                            {% endif %}
                            {% if is_granted('ROLE_ADMIN') %}
                                {{ form_start(receperio_form, {'attr': {'class': 'form-inline'}}) }}
                                {{ form_widget(receperio_form.rerun, {'label': 'Re-run check', 'attr': {'class': 'btn btn-danger confirm-imei-rerun'}}) }}
                                {{ form_end(receperio_form) }}
                              </td>
                            {% endif %}
                          </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-5">
                    <h2>Notes</h2>
                    {% for time,note in policy.notes %}
                        {% set note_decoded = note|json_decode() %}
                      <div class="row">
                        <b>{{ time|date }} by {{ note_decoded.name }}</b>
                      </div>
                      <div class="row">
                        {{ note_decoded.notes }}
                      </div>
                    {% endfor %}
                    <hr class="strong">
                    <div class="row">
                    {{ form_start(note_form)}}
                    {{ form_label(note_form.notes) }}
                    </div>
                    <div class="row">
                      <div class="form-group">
                        {{ form_widget(note_form.notes, {'attr': {'class': 'col-sm-12'}}) }}
                      </div>
                    </div>
                    <div class="row">
                        {{ form_widget(note_form.add, {'label': 'Add Note', 'attr': {'class': 'btn btn-success'}}) }}
                        {{ form_end(note_form) }}
                    </div>
                </div>
            </div>
                
                {% if policy.isPolicy %}
                <h3>Pot</h3>
                <table class="table table-striped">
                    <tr>
                        <td>Invitations</td>
                        <td>{{ policy.invitations|length }}</td>
                    </tr>
                    <tr>
                        <td>Connections</td>
                        <td>
                          <strong>{{ policy.connections|length }}</strong>&nbsp;:&nbsp;
                          {% for connection in policy.connections %}
                            <a href="{{ path(policy_route, {'id': connection.linkedPolicy.id }) }}">{{ connection.linkedUser.name }}</a>;
                          {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <td>Pot Value</td>
                        <td>£{{ policy.potValue|number_format(2, '.', ',') }}</td>
                    </tr>
                </table>
                {% endif %}
                <h3>Anti Fraud Checks</h3>
                <table class="table table-striped">
                    <tr>
                        <td>User Signup - Country of Ip</td>
                        <td>{{ fraud.signup_country }}</td>
                    </tr>
                    <tr>
                        <td>Other Users w/same signup ips</td>
                        <td>{{ fraud.duplicate_ip }}</td>
                    </tr>
                    <tr>
                        <td>Other Users w/same postcode</td>
                        <td>{% if fraud.duplicate_postcode %}{{ fraud.duplicate_postcode }}{% else %}N/A{% endif %}</td>
                    </tr>
                    <tr>
                        <td>Other Users w/possibly same card (same last 4, type, exp date)</td>
                        <td>{{ fraud.duplicate_bank_accounts }}</td>
                    </tr>
                    <tr>
                        <td>IMEI belonged to different user</td>
                        <td>Not yet implemented</td>
                    </tr>
                    <tr>
                        <td>Network Cancellations</td>
                      <td>{{ fraud.network_cancellations }}</td>
                    </tr>
                </table>
        </div>
        <div role="tabpanel" class="tab-pane" id="claims">
            {% if policy.claims|length > 0 %}
                <table class="table table-striped">
                    <tr>
                        <th>Date</th>
                        <th>Claims Number</th>
                        <th>Claims Type</th>
                        <th>Claims Status</th>
                        <th>Recipero Fees</th>
                        <th>Crime Ref</th>
                        <th>Flags</th>
                        <th>Notes</th>
                    </tr>
                    {% for claim in policy.claims %}
                    <tr>
                        <td style="width: 20%;">{{ claim.recordedDate|date }}</td>
                        <td style="width: 10%;">{{ claim.number }}</td>
                        <td style="width: 10%;">{{ claim.type }}</td>
                        <td style="width: 10%;">{{ claim.status }}</td>
                        <td style="width: 10%;">£{{ claim.totalChargesWithVat|number_format(2, '.', ',') }}</td>
                        <td  style="width: 10%;" class="{% if claim.crimeRef|length > 0 %}{% if claim.validCrimeRef %}success{% elseif not claim.validCrimeRef %}danger{% endif %}{% endif %}">
                          {{ claim.crimeRef }}
                        </td>
                        <td style="width: 10%;" class="{% if claim.suspectedFraud or claim.shouldCancelPolicy %}danger{% endif %}">
                          {% if claim.suspectedFraud %}Suspected Fraud;{% endif %}
                          {% if claim.shouldCancelPolicy %}Policy should be cancelled;{% endif %}
                        </td>
                        <td style="width: 20%;">{{ claim.notes }}</td>
                    </tr>
                    {% endfor %}
                </table>
            {% else %}
            <h4>No claims</h4>
            {% endif %}
        </div>
        <div role="tabpanel" class="tab-pane" id="network">
            {% if policy.hasNetworkClaim %}
                <table class="table table-striped">
                    <tr>
                        <th>Date</th>
                        <th>Policy Number</th>
                        <th>Claims Number</th>
                        <th>Claims Type</th>
                        <th>Claims Status</th>
                        <th>Suspected Fraud</th>
                        <th>Notes</th>
                    </tr>
                    {% for claim in policy.networkClaims %}
                    <tr>
                        <td style="width: 20%;">{{ claim.recordedDate|date }}</td>
                        <td style="width: 10%;">{{ claim.number }}</td>
                        <td style="width: 10%;">{{ claim.type }}</td>
                        <td style="width: 10%;">{{ claim.status }}</td>
                        <td  style="width: 10%;" class="{% if claim.crimeRef|length > 0 %}{% if claim.validCrimeRef %}success{% elseif not claim.validCrimeRef %}danger{% endif %}{% endif %}">
                          {{ claim.crimeRef }}
                        </td>
                        <td style="width: 10%;" class="{% if claim.suspectedFraud or claim.shouldCancelPolicy %}danger{% endif %}">
                          {% if claim.suspectedFraud %}Suspected Fraud;{% endif %}
                          {% if claim.shouldCancelPolicy %}Policy should be cancelled;{% endif %}
                        </td>
                        <td style="width: 30%;">{{ claim.notes }}</td>
                    </tr>
                    {% endfor %}
                </table>
            {% else %}
            <h4>No network claims</h4>
            {% endif %}
        </div>
        <div role="tabpanel" class="tab-pane active" id="user">
            <table class="table table-striped">
                <tr>
                    <td>User Id</td>
                    <td>{{ policy.user.id }}</td>
                </tr>
                <tr>
                    <td>Name</td>
                    <td>{{ policy.user.name }}</td>
                </tr>
                <tr>
                    <td>Email</td>
                    <td>{{ policy.user.email }}</td>
                </tr>
                <tr>
                    <td>Mobile</td>
                    <td>{{ policy.user.mobileNumber }}</td>
                </tr>
                <tr>
                    <td>Billing Address</td>
                    <td>{{ policy.user.billingAddress }}</td>
                </tr>
                <tr>
                    <td>User Status</td>
                    <td>{% if policy.user.locked %}locked{% elseif policy.user.enabled %}enabled{% else %}disabled{%endif %}</td>
                </tr>
            </table>
        </div>
        <div role="tabpanel" class="tab-pane" id="history">
            <h3>User History</h3>
            <table>
            {% for item in user_history %}
              <tr>
                <td width="10%">{{ item.action }}</td>
                <td width="10%">{{ item.loggedAt|date }}</td>
                <td width="80%">
                  {% for key, value in item.data %}
                    {{ key }} => {{ value|json_encode }}<br />
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
            </table>
            {% if user_history|length == 0 %}
              <p>No history is present</p>
            {% endif %}
            <h3>Policy History</h3>
            <table>
            {% for item in policy_history %}
              <tr>
                <td width="10%">{{ item.action }}</td>
                <td width="10%">{{ item.loggedAt|date }}</td>
                <td width="80%">
                  {% for key, value in item.data %}
                    {{ key }} => {{ value|json_encode }}<br />
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
            </table>
            {% if policy_history|length == 0 %}
              <p>No history is present</p>
            {% endif %}
        </div>
      {% if is_granted('ROLE_ADMIN') %}
        <div role="tabpanel" class="tab-pane" id="admin">
            <h3>Admin</h3>
            <table class="table table-striped">
                <tr>
                    <td>Imei</td>
                    <td>
                      {{ form_start(imei_form, {'attr': {'class': 'form-inline'}}) }}
                      <div class="form-group">
                          {{ form_errors(imei_form.imei) }}
                          {{ form_widget(imei_form.imei) }}
                      </div>
                      {{ form_widget(imei_form.update, {'label': 'Update', 'attr': {'class': 'btn btn-danger confirm-imei-update'}}) }}
                      {{ form_end(imei_form) }}
                    </td>
                </tr>
                <tr>
                    <td>Phone</td>
                    <td>
                      {{ form_start(phone_form, {'attr': {'class': 'form-inline'}}) }}
                      <div class="form-group">
                          {{ form_errors(phone_form.phone) }}
                          {{ form_widget(phone_form.phone) }}
                      </div>
                      {{ form_widget(phone_form.next, {'label': 'Update', 'attr': {'class': 'btn btn-danger confirm-phone-update'}}) }}
                      {{ form_end(phone_form) }}
                    </td>
                </tr>
                <tr>
                    <td>Facebook</td>
                    <td>
                      {% if policy.user.facebookId | length > 0 %}
                            <img src="https://graph.facebook.com/{{ policy.user.facebookId }}/picture" />
                            {{ policy.user.facebookId }}
                      {% else %}
                          Not present
                      {% endif %}  
                      {{ form_start(facebook_form, {'attr': {'class': 'form-inline'}}) }}
                      {{ form_widget(facebook_form.clear, {'label': 'Clear', 'attr': {'class': 'btn btn-danger confirm-facebook-clear'}}) }}
                      {{ form_end(facebook_form) }}
                    </td>
                </tr>
                <tr>
                    <td>Salva Policy Numbers</td>
                    <td>
                        {% for key, value in policy.salvaPolicyNumbers %}
                            <ul>
                                {{ key }} - {{ value }}
                            </ul>
                        {% endfor %}
                    </td>
                </tr>
                <tr>
                    <td>Salva Policy Results</td>
                    <td>
                        {% for key, value in policy.salvaPolicyResultsUnserialized %}
                            <ul>
                                {{ key }} - {{ value|json_encode }}
                            </ul>
                        {% endfor %}
                    </td>
                </tr>
            </table>
        </div>
      {% endif %}
    </div>
    <div style="padding-bottom: 30px"></div>

    {% include 'AppBundle::Claims/phoneAlternativesModal.html.twig' %}

    <div class="modal fade" id="paymentsModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Payments</h4>
          </div>
          <div class="modal-body">

            <h4>Paid</h4>
            <table class="table table-striped">
              <tbody>
                  <tr>
                      <th>Type</th>
                      <th>Date</th>
                      <th>Amount</th>
                      <th>Status</th>
                  </tr>
                  {% for payment in policy.payments %}
                    <tr>
                        <td>
                            {% if payment.type == 'judo' %}
                                <i class="fa fa-credit-card" title="JudoPay"></i>
                            {% elseif payment.type == 'sosure' %}
                                <i class="fa fa-smile-o"" title="so-sure Credit/Debit"></i>
                            {% else %}
                                <i class="fa fa-question" title="Type: {{ payment.type }}"></i>
                            {% endif %}
                            {% if payment.source == 'web' %}
                                <i class="fa fa-globe" title="Web Payment"></i>
                            {% elseif payment.source == 'mobile' %}
                                <i class="fa fa-mobile" title="Mobile Payment"></i>
                            {% elseif payment.source == 'token' %}
                                <i class="fa fa-gears" title="Token Payment"></i>
                            {% elseif payment.source == 'apple-pay' %}
                                <i class="fa fa-apple" title="Apple Payment"></i>
                            {% elseif payment.source == 'android-pay' %}
                                <i class="fa fa-android" title="Android Payment"></i>
                            {% elseif payment.source == 'sosure' %}
                                <i class="fa fa-exchange" title="so-sure Auto Payment (not scheduled)"></i>
                            {% else %}
                                <i class="fa fa-question" title="Source: {{ payment.source }}"></i>
                            {% endif %}
                        </td>
                        <td>
                            {{ payment.date | date('d M Y H:i', 'Europe/London') }}
                        </td>
                        <td>
                            £{{ payment.amount | number_format(2, '.', ',') }}
                        </td>
                        <td>
                            {% if payment.isSuccess %}
                                <i class="fa fa-check text-success"></i>
                            {% else %}
                                <i class="fa fa-minus text-danger"></i>
                            {% endif %}
                        </td>
                    </tr>                      
                  {% endfor %}
              </tbody>
            </table>
            <h4>Scheduled</h4>
            <table class="table table-striped">
              <tbody>
                  <tr>
                      <th>Type</th>
                      <th>Date</th>
                      <th>Amount</th>
                      <th>Status</th>
                  </tr>
                  {% for scheduledPayment in policy.scheduledPayments %}
                    <tr>
                        <td>
                            {% if scheduledPayment.type == 'scheduled' %}
                                <i class="fa fa-clock-o" title="Scheduled Payment"></i>
                            {% elseif scheduledPayment.type == 'rescheduled' %}
                                <i class="fa fa-refresh" title="Re-Scheduled Payment"></i>
                            {% else %}
                                {{ scheduledPayment.type }}
                            {% endif %}
                        </td>
                        <td>
                            {% if scheduledPayment.status == 'cancelled' %}<del>{% endif %}
                            {{ scheduledPayment.scheduled | date('d M Y H:i', 'Europe/London') }}
                            {% if scheduledPayment.status == 'cancelled' %}</del>{% endif %}
                        </td>
                        <td>
                            £{{ scheduledPayment.amount | number_format(2, '.', ',') }}
                        </td>
                        <td>
                            {{ scheduledPayment.status }}            
                        </td>
                    </tr>                      
                  {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

</div>
