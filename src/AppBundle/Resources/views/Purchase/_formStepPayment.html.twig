{{ form_start(purchase_form, {'attr': {
    'data-toggle': 'validator',
    'class': 'validate-form form-400',
    'data-client-validation': form_client_validation,
    'autocomplete': 'off'
}}) }}
    {% include 'AppBundle::Purchase/_purchaseStepsRebrand.html.twig' %}
    {% if purchase_form.vars.value.amount == phone.currentMonthlyPhonePrice.monthlyPremiumPrice %}
        {% set premium = 'monthly' %}
    {% else %}
        {% set premium = 'yearly' %}
    {% endif %}
    {% set withoutDiscount = phone.currentMonthlyPhonePrice.monthlyPremiumPrice(app.user.additionalPremium)|number_format(2, '.', ',') * 12 %}
    {% set yearlyMonthly = phone.currentYearlyPhonePrice.yearlyPremiumPrice(app.user.additionalPremium) / 12 %}
    {% set saving = withoutDiscount - phone.currentYearlyPhonePrice.yearlyPremiumPrice(app.user.additionalPremium) %}
    <h2 class="text-dodger-blue text-center">How would you like to pay?</h2>
    <p class="text-center mb-4">Get {{ free_months }} free when you pay yearly ðŸ¤‘</p>
    <div class="form-group payment-options {% if form_errors(purchase_form.amount) %}has-error{% endif %}">
        <div class="radio-btn-original">
            {{ form_label(purchase_form.amount, 'Payment options') }}
            {{ form_widget(purchase_form.amount) }}
        </div>
        <div class="radio-btn-group mb-4">
            <div class="row">
                {% if app.user.allowedMonthly %}
                    <div class="col-6">
                        <div class="radio-btn {% if purchase_form.vars.value.amount == phone.currentMonthlyPhonePrice.monthlyPremiumPrice %}radio-btn-active{% endif %}"
                            data-value="{{ phone.currentMonthlyPhonePrice.monthlyPremiumPrice|number_format(2, '.', ',') }}" data-premium-type="month" data-premium-param="monthly">
                            <div class="radio-btn__content">
                                <h6 class="radio-btn__title">Pay Monthly</h6>
                                <hr class="my-2" />
                                <div class="radio-btn__price"><strong>&pound;{{ phone.currentMonthlyPhonePrice.monthlyPremiumPrice(app.user.additionalPremium)|number_format(2, '.', ',') }}</strong></div>      
                                <small class="mb-2 d-inline-block">Billed monthly</small><br>
                                <small>&pound;{{ withoutDiscount }} a year</small><br>
                                <small>&nbsp;</small>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if app.user.allowedYearly %}
                    <div class="col-6">
                        <div class="radio-btn {% if purchase_form.vars.value.amount ==
                            phone.currentYearlyPhonePrice.yearlyPremiumPrice(app.user.additionalPremium) %}radio-btn-active{% endif %}" data-value="{{ phone.currentYearlyPhonePrice.yearlyPremiumPrice|number_format(2, '.', ',') }}" data-premium-type="year" data-premium-param="yearly">
                            <div class="radio-btn__badge">
                                <div class="radio-btn__badge-inner text-white">
                                    Save <br> &pound;{{ saving|number_format(0, '.', ',') }}
                                </div>
                            </div>
                            <div class="radio-btn__content">
                                <h6 class="radio-btn__title">Pay Yearly</h6>
                                <hr class="my-2" />
                                <div class="radio-btn__price"><strong>&pound;{{ phone.currentYearlyPhonePrice.yearlyPremiumPrice|number_format(2, '.', ',') }}</strong></div>
                                <small class="mb-2 d-inline-block">Billed yearly</small><br>
                                <small>&pound;{{ phone.currentMonthlyPhonePrice.monthlyPremiumPrice(app.user.additionalPremium)|number_format(2, '.', ',') }} per month</small><br>
                                <small>&nbsp;</small>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="with-errors">{{ form_errors(purchase_form.amount) }}</div>
    </div>
    {% set scode_label = 'Have a promocode or referral code? Enter it here' %}
    {% set scode_class = 'form-control' %}
    {% if user_code is not null %}
        {% set scode_type = 'referral' %}
        {% if user_code_type == 'reward' %}
            {% set scode_type = 'reward' %}
        {% endif %}
        {% set scode_label = 'The ' ~ scode_type ~ ' code ' ~ user_code ~ ' has been applied' %}
        {% set scode_class = 'form-control hideme' %}
    {% endif %}
    <div class="form-group {% if form_errors(purchase_form.promoCode) %}has-error{% endif %} mb-4">
        {{ form_label(purchase_form.promoCode, scode_label, { 'label_attr': {'class': ''} }) }}
        {{ form_widget(purchase_form.promoCode, {'attr':{
            'class': scode_class,
            'placeholder': 'Enter code'
        }}) }}
        <div class="with-errors">{{ form_errors(purchase_form.promoCode) }}</div>
    </div>
    {% set button_text = 'Pay Now' %}
    {% set button_class = 'btn btn-success btn-block-xs btn-card-pay' %}
    {% if feature_enabled('card-option-with-bacs') %}
        {% set button_text = 'Pay via Card' %}
        {% set button_class = 'btn btn-outline-default btn-block-xs btn-card-pay' %}
        <div class="form-group text-center">
            {{ form_widget(purchase_form.next, {
            'label': 'Setup Direct Debit',
            'fa': 'far fa-university fa-lg ml-2',
            'right': true,
            'attr': {
                'class': 'btn btn-success btn-block-xs'
            }}) }}
        </div>
    {% else %}
        <div class="form-group text-center">
            {{ form_widget(purchase_form.next, {     
            'attr': {
                'hidden': 'hidden'
            }}) }}    
        </div>        
    {% endif %}
{{ form_end(purchase_form) }}
<div class="mb-4">
    <form class="payment-form"
          method="POST"
          data-public-key="{{ checkoutApiKey(policy) }}"
          data-customer-email="{{ app.user.email }}"
          data-value="{{ convert_to_pennies(purchase_form.amount.vars.value) }}"
          data-currency="GBP"
          data-csrf="{{ csrf_token('checkout') }}"
          data-payment-mode="cards"
          data-card-form-mode="cardTokenisation"
          data-debug-mode="{% if environment != 'prod' %}true{% else %}false{% endif %}"
          data-url="{{ url('purchase_checkout', {'id': policy.id, 'pennies': convert_to_pennies(purchase_form.amount.vars.value), 'premium': premium }) }}"
          data-redirect-url="
          {% if instore is not null and instore == true %}
            {{ path('user_instore', {id: policy.id}) }}
          {% elseif validation_required is not null and validation_required is not null %}
            {{ path('user_validation_required', {id: policy.id}) }}
          {% else %}
            {{ path('user_welcome', {id: policy.id}) }}
          {% endif %}"
          data-title="Pay now"
          data-subtitle="Please enter your card details"
          data-scode="{% if user_code is not null %}{{ user_code }}{% endif %}">
    </form>
    <div class="form-group">
        {% block to_card_form %}
            {{ form_start(to_card_form, {'attr':{'class':'form-400 text-center'}}) }}
                {{ form_widget(to_card_form.submit, {
                    'label': button_text,
                    'fa': 'fas fa-credit-card fa-lg ml-2',
                    'right': true,                                
                    'attr': {
                        'class': button_class
                }}) }}
            {{ form_end(to_card_form) }}
        {% endblock to_card_form %}
    </div>
    <div class="form-group text-center mt-4">
        <small class="text-grey">Card payments powered by</small><br>
        <img src="{{ cdn_url }}/images/rebrand/misc/so-sure_checkout-logo.png" alt="Checkout" title="Powered by - Checkout" width="125px" class="mt-2">
    </div>
</div>
