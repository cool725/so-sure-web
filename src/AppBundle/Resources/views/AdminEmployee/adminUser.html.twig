{% extends 'base.html.twig' %}

{% block body %}
<div class="container">
    <div class="row">
        <div class="col-sm-8">
            <h2>User - {{ user.name }}</h2>
        </div>
        <div class="col-sm-4" style="margin-top: 20px">
            <i class="fa fa-warning" title="TODO: Edit name/mobile/email (only if policy not purchase!!)"></i>
        </div>
    </div>
            <table class="table table-striped">
                <tr>
                    <td>Id</td>
                    <td>{{ user.id }}</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Email</td>
                    <td>{{ user.email }} </td>
                    <td>
                        {{ form_start(reset_form) }}
                        {{ form_widget(reset_form.reset, {'label': 'Send reset email', 'attr': {'class': 'btn btn-danger'}}) }}
                    </td>
                </tr>
                <tr>
                    <td>Name</td>
                    <td>{{ user.name }}
                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('user_home', {'id': user.id, '_impersonate': user.username}) }}">Login as user</a>
                        {% endif %}
                    </td>
                    <td>
                            <button type="button" class="btn btn-info {% if user.hasActivePolicy %}disabled{% endif %}" data-toggle="modal" data-target="#userDetailModal"
                               {% if user.hasActivePolicy %}title="Active policy - no changes allowed" disabled{% endif %} ><i class="fa fa-edit"></i> Edit User Details</button>
                    </td>
                </tr>
                <tr>
                    <td>Birthday</td>
                    <td>{% if user.birthday %}{{ user.birthday|date('d M Y', 'Europe/London') }}{% else %}Not set{% endif %}
                    </td>
                    <td>
                            <button type="button" class="btn btn-info {% if user.hasActivePolicy %}disabled{% endif %}" data-toggle="modal" data-target="#userDetailModal"
                               {% if user.hasActivePolicy %}title="Active policy - no changes allowed" disabled{% endif %} ><i class="fa fa-edit"></i> Edit User Details</button>
                    </td>
                </tr>
                <tr>
                    <td>Mobile</td>
                    <td>{{ user.mobileNumber }}</td>
                    <td>
                            <button type="button" class="btn btn-info {% if user.hasActivePolicy %}disabled{% endif %}" data-toggle="modal" data-target="#userDetailModal"
                               {% if user.hasActivePolicy %}title="Active policy - no changes allowed" disabled{% endif %} ><i class="fa fa-edit"></i> Edit User Details</button>

                    </td>
                </tr>
                <tr>
                    <td>Billing Address</td>
                    <td>{{ user.billingAddress }}</td>
                    <td></td>
                </tr>
                <tr>
                    <td>User Status</td>
                    <td>
                        {% if user.locked %}locked{% elseif user.enabled %}enabled{% else %}disabled{%endif %}
                    </td>
                    <td>
                        <i class="fa fa-warning" title="TODO: Enable/Disable/Lock"></i>
                    </td>
                </tr>
                <tr>
                    <td>Policies</td>
                    <td>
                        {% for policy in user.allPolicies %}
                            {% if policy.policyNumber|length > 0 %}
                                <a href="{{ path('admin_policy', {'id': policy.id }) }}">
                                    {{ policy.policyNumber }}
                                </a> ({{ policy.status }})
                            {% else %}
                                <a href="{{ path('admin_policy', {'id': policy.id }) }}">{{ policy.id }} (In progress)</a>
                            {% endif %}
                            <br />
                        {% endfor %}
                        {% if user.allPolicies|length == 0 %}
                            No policies
                        {% endif %}
                    </td>
                    <td>
                            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#newPolicyModal"
                                ><i class="fa fa-plus"></i> Add partial policy</button>
                    </td>
                </tr>
            </table>
</div>

    <div class="modal fade" id="newPolicyModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
            {{ form_start(policy_form) }}
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Add Partial Policy</h4>
            <p>For cases where IMEI detection is failing</p>
          </div>
          <div class="modal-body">
            <div class="row">
                <div class="form-group col-sm-4">
                    {{ form_label(policy_form.phone, 'Phone') }}
                </div>
                <div class="form-group col-sm-4">
                    {{ form_errors(policy_form.phone) }}
                    {{ form_widget(policy_form.phone) }}
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-4">
                    {{ form_label(policy_form.imei, 'IMEI') }}
                </div>
                <div class="form-group col-sm-4">
                    {{ form_errors(policy_form.imei) }}
                    {{ form_widget(policy_form.imei) }}
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-4">
                    {{ form_label(policy_form.serialNumber, 'Serial Number') }}
                </div>
                <div class="form-group col-sm-4">
                    {{ form_errors(policy_form.serialNumber) }}
                    {{ form_widget(policy_form.serialNumber) }}
                </div>
            </div>
            <div class="row">
                <div class="form-group text-center col-sm-12" style="padding-top: 10px;">
                    {{ form_widget(policy_form.add, {'label': 'Create Partial Policy', 'attr': {'class': 'btn btn-warning'}}) }}
                </div>
            </div>
          </div>
            {{ form_end(policy_form) }}
        </div>
      </div>
    </div>

    <div class="modal fade" id="userDetailModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document" style="width: 60%;">
        <div class="modal-content">
            {{ form_start(user_detail_form )}}
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Edit User Details</h4>
          </div>
          <div class="modal-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        {{ form_label(user_detail_form.firstName) }}
                        {{ form_errors(user_detail_form.firstName) }}
                        {{ form_widget(user_detail_form.firstName) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(user_detail_form.lastName) }}
                        {{ form_errors(user_detail_form.lastName) }}
                        {{ form_widget(user_detail_form.lastName) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(user_detail_form.birthday) }}
                        {{ form_errors(user_detail_form.birthday) }}
                        {{ form_widget(user_detail_form.birthday) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(user_detail_form.mobileNumber) }}
                        {{ form_errors(user_detail_form.mobileNumber) }}
                        {{ form_widget(user_detail_form.mobileNumber) }}
                    </div>
                </div>
            </div>
          </div>
          <div class="modal-footer">
                {{ form_widget(user_detail_form.update, {'label': 'Update User', 'attr': {'class': 'btn btn-success'}}) }}
          </div>
            {{ form_end(user_detail_form )}}
        </div>
      </div>
    </div>

{% endblock %}
