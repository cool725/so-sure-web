{% extends 'base.html.twig' %}

{% macro display_actions(phone, token) %}
  <button type="button" class="btn {% if phone.suggestedReplacement %}btn-info{% elseif phone.replacementPrice > 0 %}btn-info{% else %}btn-primary{% endif %}" data-toggle="modal" data-target="#alternativeModal"
      data-query="{{ path('claims_phone_alternatives', {'id': phone.id}) }}"
      data-phone="{{ phone.toAlternativeArray()|json_encode }}"
      {% if phone.replacementPrice > 0 %}disabled="disabled"{% endif %}
      ><i class="fa fa-book"></i></button>
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#phoneModal"
      data-update="{{ path('admin_phone_edit', {'id': phone.id}) }}"
      data-ipt-rate="{{ phone.currentIptRate }}"
      data-phone="{{ phone.toEditArray()|json_encode }}"><i class="fa fa-edit"></i></button>
  <button type="button" class="btn btn-danger phone-delete" data-token="{{ token }}"
          data-delete="{{ path('admin_phone_delete', {'id': phone.id}) }}"><i class="fa fa-trash"></i></button>
{% endmacro display_actions %}

{% block javascripts %}
    {{ parent() }}
    {% javascripts
        '@AppBundle/Resources/public/js/tabs.js'
        '@AppBundle/Resources/public/js/Admin/phone.js'
        '@AppBundle/Resources/public/js/Claims/phoneAlternativesModal.js'
    %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
{% endblock %}

{% import _self as this %}
{% block body %}
<div class="container">
    <div class="bg-info" style="border-radius: 10px; padding: 10px;">
    <h4 class="text-center"><strong>Phones</strong></h4>
    <div class="row">
    {{ form_start(form) }}
        <div class="form-group">
            {{ form_label(form.os, 'Os', {'label_attr': {'class': 'col-sm-3'}}) }}
            {{ form_errors(form.os) }}
            {{ form_widget(form.os, {'attr': {'class': 'col-sm-6'}}) }}
        </div>
        <div class="form-group">
            {{ form_label(form.active, 'Active', {'label_attr': {'class': 'col-sm-1'}}) }}
            {{ form_errors(form.active) }}
            {{ form_widget(form.active, {'attr': {'class': 'col-sm-2'}}) }}
        </div>
        <div class="form-group">
            {{ form_label(form.rules, 'Business rules', {'label_attr': {'class': 'col-sm-3'}}) }}
            {{ form_errors(form.rules) }}
            {{ form_widget(form.rules, {'attr': {'class': 'col-sm-2'}}) }}
        </div>
        <div class="form-group">
          <div class="col-sm-2 col-sm-offset-2 text-center">
            {{ form_widget(form.search, {'label': 'Search', 'attr': {'class': 'btn btn-success'}}) }}
          </div>
        </div>

    {{ form_end(form) }}
    </div>
  </div>
  <form style="margin-top: 20px;">
    <ul class="nav nav-tabs nav-justified">
      <li role="presentation" class="active"><a href="#financial">Financial</a></li>
      <li role="presentation"><a href="#device">Device</a></li>
      <li role="presentation"><a href="#replacement">Replacement</a></li>
      <li role="presentation">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#phoneModal"
                data-update="{{ path('admin_phone_add') }}">Add new phone</button>
        
      </li>
    </ul>
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="financial">
            <div class="table-responsive">
                <table class="table table-striped table-condensed">
                    <thead>
                    <tr>
                        <th>Phone</th>
                        <th>Monthly Premium</th>
                        <th>Binder Monthly Premium (Min)</th>
                        <th>Yearly Premium</th>
                        <th>Max Pot / Max Connections</th>
                        <th>Policy Profit ({{ expected_claim_frequency * 100 }}% Claims)
                          <i class="fa fa-question" title=""></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for phone in phones %}
                      {% set phoneProfit = phone.policyProfit(expected_claim_frequency, consumer_payout, ipt_rebate) %}
                        <tr {% if not phone.active %}class="danger"{% endif %}>
                            <td>{{ phone }}
                            {% if phone.shouldBeRetired %}<span class="text-danger"><i class="glyphicon glyphicon-time" title="{{ phone.monthAge }} months old"></i></span>{% endif %}
                            </td>
                            <td>
                              £{{ phone.currentPhonePrice.monthlyPremiumPrice|number_format(2, '.', ',') }}
                              {% if phone.previousPhonePrices | length > 0 %}
                                <i class="fa fa-history" style="cursor: pointer" title="{{ phone.getPreviousPhonePricesAsString }}"></i>
                              {% endif %}
                              {% if phone.futurePhonePrices | length > 0 %}
                                <i class="fa fa-level-up" style="cursor: pointer" title="{{ phone.getFuturePhonePricesAsString }}"></i>
                              {% endif %}
                            </td>
                            <td>
                              £{{ phone.getSalvaBinderMonthlyPremium|number_format(2, '.', ',') }}
                              (£{{ phone.getSalvaMiniumumBinderMonthlyPremium|number_format(2, '.', ',') }}) 
                            </td>
                            <td>£{{ phone.currentPhonePrice.yearlyPremiumPrice|number_format(2, '.', ',') }}</td>
                            <td>£{{ phone.currentPhonePrice.maxPot|number_format(2, '.', ',') }} /
                            {{ phone.currentPhonePrice.maxConnections }}</td>
                            <td><span class="{% if phoneProfit > 0 %}text-success{% else %}text-warning{%endif %}">
                            {% if phoneProfit is null %}unknown{% else %}{{ phoneProfit|number_format(2, '.', ',') }}{% endif %}
                            </span>
                            </td>
                            <td width="152px">
                              {{ this.display_actions(phone, token) }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>        
            <div class="pagerfanta">
                {{ pagerfanta(pager, 'twitter_bootstrap3') }}
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="device">
            <div class="table-responsive">
                <table class="table table-striped table-condensed">
                    <thead>
                    <tr>
                        <th>Phone</th>
                        <th>Devices</th>
                        <th>Os</th>
                        <th>Processor</th>
                        <th>Ram</th>
                        <th>SSD Slot</th>
                        <th>Physical Screen</th>
                        <th>Screen Resolution</th>
                        <th>Camera</th>
                        <th>4G</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for phone in phones %}
                        <tr {% if not phone.active %}class="danger"{% endif %}>
                            <td>{{ phone }}</td>
                            <td><span title="{{ phone.devices|join(", ") }}">{{ phone.devices|length }}</span></td>
                            <td>{{ phone.osString }}</td>
                            <td>{{ phone.processorSpeed }}Mhz ({{ phone.processorCores }} cores)</td>
                            <td>{{ phone.ram }} MB</td>
                            <td>{% if phone.ssd %}Yes{%else%}No{%endif%}</td>
                            <td>{{ phone.screenPhysicalInch }}" ({{ phone.screenPhysical }} mm)</td>
                            <td>{{ phone.screenResolution }}</td>
                            <td>{{ phone.camera }} MP</td>
                            <td>{% if phone.lte %}Yes{%else%}No{%endif%}</td>
                            <td width="152px">
                              {{ this.display_actions(phone, token) }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>        
            <div class="pagerfanta">
                {{ pagerfanta(pager, 'twitter_bootstrap3') }}
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="replacement">
            <div class="table-responsive">
                <table class="table table-striped table-condensed">
                    <thead>
                    <tr>
                        <th>Phone</th>
                        <th>Initial Price</th>
                        <th>Replacement Price</th>
                        <th>Suggested Replacement Phone</th>
                        <th>Age</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for phone in phones %}
                        <tr {% if not phone.active %}class="danger"{% endif %}>
                            <td>{{ phone }}</td>
                            <td>£{{ phone.initialPrice|number_format(2, '.', ',') }}</td>
                            <td>
                                {% if phone.suggestedReplacement %}
                                    £{{ phone.suggestedReplacement.replacementPrice|number_format(2, '.', ',') }}
                                    <i class="fa fa-info-circle" title="Replacement Price for suggested {{ phone.suggestedReplacement }}"></i>
                                    {% if phone.suggestedReplacement.initialPrice > phone.initialPrice + 30 %}
                                      <i class="fa fa-warning" title="Suggested replacement phone is more than £30 than original (£{{ phone.suggestedReplacement.initialPrice - phone.initialPrice }})"></i>
                                    {% endif %}
                                {% elseif phone.replacementPrice > 0 %}
                                    £{{ phone.replacementPrice|number_format(2, '.', ',') }}
                                {% endif %}
                            </td>
                            <td>
                                {% if phone.suggestedReplacement %}
                                    {{ phone.suggestedReplacement }}
                                {% elseif phone.replacementPrice %}
                                  Direct replacement available
                                {% endif %}
                            </td>
                            <td><span class="{% if phone.shouldBeRetired %}text-danger{% else %}text-muted{% endif %}">{{ phone.monthAge }} months</span></td>
                            <td width="152px">
                              {{ this.display_actions(phone, token) }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>        
            <div class="pagerfanta">
                {{ pagerfanta(pager, 'twitter_bootstrap3') }}
            </div>
        </div>
    </div>
  </form>

    {% include 'AppBundle::Claims/phoneAlternativesModal.html.twig' %}

    <div class="modal fade" id="phoneModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
        <form id="phone-update-form" class="form-horizontal" method="post">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="exampleModalLabel">New phone</h4>
          </div>
          <div class="modal-body">
              <div class="form-group">
                <label for="phone-make" class="control-label col-sm-2">Make:</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="phone-make" name="make">
                </div>
              </div>
              <div class="form-group">
                <label for="phone-model" class="control-label col-sm-2">Model:</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="phone-model" name="model">
                </div>
              </div>
              <div class="form-group">
                <label for="phone-devices" class="control-label col-sm-2">Devices:</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="phone-devices" name="devices">
                </div>
              </div>
              <div class="form-group">
                <label for="phone-memory" class="control-label col-sm-2">Memory:</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="phone-memory" name="memory">
                </div>
              </div>
              <div class="form-group">
                <label for="phone-gwp" class="control-label col-sm-2">GWP:</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="phone-gwp" name="gwp" readonly="true" disabled="disabled">
                </div>
              </div>
              <div class="form-group">
                <label for="phone-premium" class="control-label col-sm-2">Monthly Premium Price:</label>
                <div class="col-sm-10">
                <input type="text" class="form-control" id="phone-premium" name="premium" readonly="true" disabled="disabled">
                </div>
              </div>
              <div class="form-group">
                <label for="phone-active" class="control-label col-sm-2">Active:</label>
                <div class="col-sm-10">
                <label class="radio-inline">
                  <input type="radio" id="phone-active-yes" value="true" name="active">Yes
                </label>
                <label class="radio-inline">
                  <input type="radio" id="phone-active-no" value="false" name="active">No
                </label>
                </div>
              </div>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="token" value="{{ token }}" />
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
        </div>
      </div>
    </div>
</div>
{% endblock %}
