version: 0.2
os: linux
run-as: root
phases:
  install:
    commands:
      - cat /etc/security/limits.conf
      - ulimit -a
      - ulimit -n 64000
      - ulimit -a
      - cd /var/ops; git pull origin master; cd $CODEBUILD_SRC_DIR
      - /usr/bin/redis-server --port 6379 &
      - /usr/bin/mongod --dbpath /tmp --fork --logpath /tmp/mongo.log --logappend
      - /var/ops/ansible/create-parameters.sh build
      - /var/ops/scripts/install-vendors.sh -n -u jenkins $CODEBUILD_SRC_DIR test
      - /var/ops/scripts/create-folders.sh -n -u jenkins $CODEBUILD_SRC_DIR test
      - /var/ops/scripts/clear-cache.sh $CODEBUILD_SRC_DIR test
      - /var/ops/scripts/run-encore.sh $CODEBUILD_SRC_DIR test
  build:
    commands:
      - ./build/run-test-functional.sh -l
artifacts:
  files:
    - logs/test.log